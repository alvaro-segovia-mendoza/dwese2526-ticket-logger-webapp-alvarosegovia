user  nginx;
# Define el usuario con el que Nginx ejecutará los procesos de trabajo (worker processes).
# Aquí se usa 'nginx', que ya existe en la imagen oficial.

worker_processes  auto;
# Número de procesos worker que Nginx va a crear.
# 'auto' deja que Nginx decida según el número de CPU disponibles.

events {
    worker_connections  1024;
    # Número máximo de conexiones simultáneas que puede manejar cada worker.
    # 1024 es suficiente para la mayoría de aplicaciones pequeñas/medianas.
}

http {
    include     /etc/nginx/mime.types;
    # Carga tipos MIME desde el archivo mime.types.
    # Esto permite a Nginx servir correctamente diferentes tipos de archivos (css, js, png, etc.).

    default_type  application/octet-stream;
    # Tipo por defecto para archivos desconocidos (binario genérico).

    access_log  /var/log/nginx/access.log;
    # Ruta del log de accesos.

    error_log   /var/log/nginx/error.log warn;
    # Ruta del log de errores con nivel 'warn'.

    sendfile    on;
    # Habilita el envío eficiente de archivos mediante sendfile() del sistema operativo.

    keepalive_timeout  65;
    # Tiempo en segundos que Nginx mantiene conexiones HTTP persistentes abiertas.

    upstream ticket_logger_backend {
        server ticket-logger-app:8080;
        # Define un "upstream" llamado ticket_logger_backend apuntando al contenedor de la app.
        # Nginx enviará las solicitudes a este backend.
    }

    server {
        listen 80;
        # Escucha en HTTP puerto 80

        server_name localhost;
        # Nombre del servidor (dominio). Para local, usamos localhost.

        return 301 https://$host$request_uri;
        # Redirige automáticamente todo el tráfico HTTP a HTTPS (301 Moved Permanently).
    }

    server {
        listen 443 ssl;
        # Escucha en HTTPS puerto 443

        server_name localhost;
        # Nombre del servidor (localhost)

        ssl_certificate     /etc/nginx/certs/server.crt;
        # Ruta del certificado TLS/SSL

        ssl_certificate_key /etc/nginx/certs/server.key;
        # Ruta de la clave privada TLS/SSL

        ssl_protocols TLSv1.2 TLSv1.3;
        # Protocolos TLS permitidos (solo versiones seguras)

        ssl_ciphers HIGH:!aNULL:!MD5;
        # Cifras permitidas: HIGH indica cifrados fuertes, excluye cifrados sin autenticación o MD5.

        location / {
            proxy_pass          http://ticket_logger_backend;
            # Reenvía todas las solicitudes al backend definido anteriormente (tu app Spring Boot)

            proxy_set_header    Host $host;
            # Pasa el host original al backend

            proxy_set_header    X-Real-IP $remote_addr;
            # Pasa la IP real del cliente al backend

            proxy_set_header    X-Forward-Proto https;
            # Indica al backend que la conexión original era HTTPS
        }
    }
}
