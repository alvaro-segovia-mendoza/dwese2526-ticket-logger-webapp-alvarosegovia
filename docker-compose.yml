services:
  db:
    image: mariadb:latest
    # Servicio de base de datos MariaDB, usando la última versión disponible.

    environment:
      - MARIADB_ROOT_PASSWORD=${DB_ROOT_PASSWORD}
      - MARIADB_DATABASE=${DB_DATABASE}
      - MARIADB_USER=${DB_USER}
      - MARIADB_PASSWORD=${DB_PASSWORD}
    # Variables de entorno que configuran la base de datos:
    # - Contraseña del root
    # - Nombre de la base de datos que se creará
    # - Usuario y contraseña para la app
    # Valores tomados del archivo .env

    volumes:
      - db_data:/var/lib/mysql
    # Volumen persistente para almacenar los datos de MariaDB
    # Evita perder la información al destruir o recrear contenedores

  ticket-logger-app:
    build:
      context: .
      dockerfile: Dockerfile
    # Construye la imagen de la app desde el Dockerfile en el directorio actual

    container_name: ticket-logger-app
    # Nombre del contenedor (más fácil de identificar)

    env_file: .env
    # Carga variables de entorno desde el archivo .env

    environment:
      DB_URL: ${DB_URL}
      DB_USER: ${DB_USER}
      DB_PASSWORD: ${DB_PASSWORD}
      DB_DRIVER: ${DB_DRIVER}
      APP_UPLOAD_PATH: ${APP_UPLOAD_PATH}
      APP_PORT: ${APP_PORT}
    # Variables de entorno adicionales necesarias por la app Spring Boot

    depends_on:
      - db
    # Asegura que Docker inicie el servicio de base de datos antes que la app
    # **Nota:** Esto no garantiza que la base de datos esté lista para conexiones, solo que el contenedor está en marcha
    ports:
      - "8080:8080"
    volumes:
      - app_uploads:/app
    # Volumen para persistir archivos generados por la app (uploads, logs, etc.)
    # Esto asegura que los archivos no se pierdan al recrear contenedores

  phpmyadmin:
  # Imagen oficial de phpMyAdmin (interfaz web para administrar MySQL/MariaDB) image: phpmyadmin:latest
    # Nombre fijo del contenedor (útil para logs y comandos docker)
   container_name: ticket-logger-phpmyadmin
  # Asegura que el contenedor de la BD se arranque antes que phpMyAdmin
   depends_on:
    - db
   environment:
    # Host de la base de datos a la que se conectará phpMyAdmin.
    # "db" es el nombre del servicio MariaDB en este mismo docker-compose,
    # y Docker lo resuelve por DNS dentro de la red interna del compose.
    PMA_HOST: db
    # Puerto interno del servicio MariaDB dentro de la red Docker (por defecto 3306)
    PMA_PORT: 3306
    # Si está a ☺, phpMyAdmin NO te deja escribir cualquier host manualmente:
    # solo te conectas al host indicado en PMA_HOST (más seguro en aula).
    # Si lo pones a 1, podrías poner otro servidor MySQL/MariaDB en el login.
    PMA_ARBITRARY: 0
    # Límite máximo para subir ficheros desde la interfaz web (importar .sql, etc.) # Útil cuando importas dumps grandes.
    UPLOAD_LIMIT: 128M
   ports:
  # Mapea el puerto 8081 del HOST (tu VM) al puerto 80 del contenedor.
  # Acceso: http://IP_DE_LA_VM:8081
  # Consejo seguridad (alternativas):
  # - "127.0.0.1:8081:80" ->solo accesible desde la propia VM
  # "192.168.2.41:8081:80" -> solo accesible desde esa IP de la VM
    - "8081:80"

volumes:
  db_data:
  app_uploads:
  certs:
# Definición de los volúmenes persistentes usados por los servicios
# Docker creará directorios en /var/lib/docker/volumes/ para cada uno de ellos
